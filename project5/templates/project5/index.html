{% load static %}
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Project 5 ‚Äî Tasks 1‚Äì3</title>
    <link rel="stylesheet" href="{% static 'project5/styles.css' %}">
    <style>
      :root{
        --fg:#000;
        --muted:#000;
        --border:#e5e5e5;
        --btn-bg:#fafafa; --btn-border:#ddd; --btn-hover:#f2f2f2;
        --card-bg:#fbfbfb;
      }

      html, body { height: 100%; margin:0; }
      body{
        font-family: Arial, sans-serif;
        color:var(--fg);
        background-image: url("{% static 'images/bg.jpeg' %}");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .page-container{
        width:100%;
        max-width:1200px;
        padding:20px 40px;
        text-align:center;
      }

      .title-container{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        margin-top:30px;
        margin-bottom:20px;
      }

      h1{ font-size: 30px; font-weight: bold; margin:0; color:#000; }
      .project-desc{
        max-width: 800px;
        margin-top: 12px;
        font-size: 16px;
        line-height: 1.5;
        color:#000;
        text-align: center;   /* ‚úÖ center aligned */
        font-weight: normal;  /* ‚úÖ no bold */
        font-style: normal;   /* ‚úÖ no italic */
      }


      h2{ text-align:center; margin:22px 0 10px; color:#000; }
      hr{ border:none; border-top:1px solid var(--border); margin:18px auto; width:80%; }

      .task-desc{
        max-width: 900px;
        margin: 6px auto 14px;
        text-align: center;
        color: #000;
        font-size: 15px;
        line-height: 1.5;
      }

      .btn{
        padding:8px 14px;
        border:1px solid var(--btn-border);
        border-radius:10px;
        background:var(--btn-bg);
        text-decoration:none;
        cursor:pointer;
        transition: background .15s ease, transform .02s ease;
      }
      .btn:hover{ background:var(--btn-hover); }
      .btn:active{ transform: translateY(1px); }
      .btn[disabled]{ opacity:.55; cursor:not-allowed; }

      .toolbar{ display:flex; justify-content:center; gap:12px; margin:12px 0; flex-wrap:wrap; }

      .gw{ display:grid; grid-template-columns:repeat(5,48px); grid-auto-rows:48px; gap:6px; margin:12px auto; justify-content:center; }
      .tile{ border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:22px; }
      .tile-empty{ background:#fafafa; }
      .tile-mouse{ background:#dce9ff; }
      .tile-cheese{ background:#fff6bf; }
      .tile-organic{ background:#e8ffd9; }
      .tile-trap{ background:#ffe0e0; border-color:#f8a6a6; }
      .tile-wall{ background:#2a2a2a; color:#fff; border-color:#2a2a2a; }

      .legend{ display:flex; justify-content:center; gap:16px; margin-top:12px; flex-wrap:wrap; }
      .legend .leg{ width:28px; height:28px; font-size:16px; margin-right:6px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:6px; background:#fff; }

      .results{ margin:12px auto; padding:12px; border:1px solid var(--border); border-radius:10px; background:var(--card-bg); max-width:600px; }

      form{ margin:10px auto; text-align:center; }
      form label{ color:#000; }
      form input, form select{ border:1px solid var(--border); border-radius:8px; padding:6px 8px; font-size:14px; background:#fff; color:#000; }
    </style>
  </head>
  <body>
    <!-- title + project description -->
    <div class="title-container">
      <h1>Project 5 ‚Äî Reinforcement Learning with Human Feedback</h1>
      <p class="project-desc">
        This project explores human-centric reinforcement learning by combining policy gradient 
        methods with human preferences. You‚Äôll train a REINFORCE agent in a 5√ó5 grid-world, 
        sample trajectories for comparison, and use human feedback to build a reward model 
        and fine-tune the agent with RLHF (Reinforcement Learning with Human Feedback).
      </p>
    </div>
    <div class="page-container">

      <div class="toolbar">
        <a class="btn" href="{% url 'project5:reshuffle' %}">üîÄ Reshuffle Grid</a>
      </div>

      <!-- Grid -->
      <div class="gw">
        {% for row in grid %}
          {% for cell in row %}
            <div class="tile {{ cell.cls }}">{{ cell.char }}</div>
          {% endfor %}
        {% endfor %}
      </div>

      <div class="legend">
        <div><span class="leg tile tile-mouse">üê≠</span> Mouse</div>
        <div><span class="leg tile tile-cheese">üßÄ</span> Cheese</div>
        <div><span class="leg tile tile-organic">üßÄ</span> Organic</div>
        <div><span class="leg tile tile-trap">‚ò†Ô∏è</span> Trap</div>
        <div><span class="leg tile tile-wall">üß±</span> Wall</div>
        <div><span class="leg tile tile-empty"></span> Empty</div>
      </div>

      <hr>

      <!-- Task 1 -->
      <h2>Task 1 ‚Äî Train REINFORCE Policy</h2>
      <p class="task-desc">
        Learn a policy in a 5√ó5 grid-world by simulating trajectories and applying REINFORCE: 
        estimate the policy gradient from returns and update the network to favor actions that 
        lead to cheese (+10) while avoiding traps (‚àí50) and unnecessary moves (‚àí0.2).
      </p>
      <form method="post" action="{% url 'project5:train' %}">
        {% csrf_token %}
        {{ form.as_p }}
        <button class="btn" type="submit">Train</button>
      </form>

      {% if show_results %}
      <div class="results">
        <strong>Training complete.</strong>
        <div>Mean episodic return (eval): {{ mean_return|floatformat:2 }}</div>
        <div>Std episodic return (eval): {{ std_return|floatformat:2 }}</div>
      </div>
      {% endif %}

      <hr>

      <!-- Task 2 -->
      <h2>Task 2 ‚Äî Sample Trajectories & Give Preferences</h2>
      <p class="task-desc">
        Generate pairs of trajectories and let a human label which one is preferred. 
        This feedback is collected to guide reward modeling in the next step.
      </p>
      {% if trained %}
        <p>
          <a class="btn" href="{% url 'project5:sample' %}">Sample trajectories</a>
          {% if num_prefs %}<span style="margin-left:8px;">Preferences collected: {{ num_prefs }}</span>{% endif %}
        </p>
      {% else %}
        <p>Train the model first to enable trajectory sampling.</p>
      {% endif %}

      <hr>

      <!-- Task 3 -->
      <h2>Task 3 ‚Äî Learn Reward & RLHF Fine-Tune</h2>
      <p class="task-desc">
        Use the collected human preferences to train a reward model, then fine-tune the policy 
        with Reinforcement Learning from Human Feedback (RLHF) to align better with human choices.
      </p>
      {% if trained %}
        <form method="post" action="{% url 'project5:fit_reward' %}">
          {% csrf_token %}
          <button class="btn" type="submit" {% if num_prefs|default:0 < 1 %}disabled{% endif %}>
            Fit reward from {{ num_prefs|default:0 }} preferences
          </button>
        </form>
      {% endif %}

      <hr>

      <!-- Reset -->
      <form method="post" action="{% url 'project5:reset' %}">
        {% csrf_token %}
        <button class="btn" type="submit" style="background:#fff3cd;border-color:#ffe69c;">Reset Session</button>
      </form>
    </div>
  </body>
</html>
